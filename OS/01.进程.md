# 进程与线程

## 多道程序设计

* multi-programming
* 吞吐量：单位时间内系统所处理的作业（程序）的道数（数量）
* 单道程序设计 --多程序同时进入系统--> 多道程序设计

## 进程

### 进程是具有一定独立功能的程序，关于一个数据集合的一次运行活动。

* 现场信息作为断点
* 程序需要一个保存断点的区域
* 该区域不是程序的组成部分
* 进程 = PCB + 程序（代码、数据）/ 进程映像 process image

### 状态 & 转换

* 运行态 run
  * 需要等待IO或其他资源 --> wait
  * CPU时间片耗尽 --> ready
* 就绪态 ready
  * 获得CPU时间片
* 等待态 wait / suspended / blocked / sleep
  * IO结束或资源得到 --> ready/run

### 进程控制块PCB

* Process Control Block
* 保存断点现场
* 标志进程存在的数据结构
* 全部信息
* 位于系统空间

### 进程上下文

* process context
* 进程的物理实体 & 支持进程运行的环境
  * 通用寄存器,SP,PSW,PC
* 进程切换 = 进程上下文切换 context switch

### 进程队列

> PCB 链
>
> 不一定完全 FIFO
* 就绪队列
* 等待队列
* 运行队列
  * 只有一个进程
  * 运行指示字：头指针

### 种类

* 系统进程
  * 守护进程 daemon
* 用户进程
* 并发性
  * 动态性
  * 独立性
  * 交互性
  * 异步性
  * 结构性 PCB

### 进程间相互作用

* 相关进程 / 无关进程
* 直接相互作用 / 间接相互作用
  * 并发时
  * 进程同步 / 资源占用等待

### 进程的创建 撤销

* fork(0)
* exit(status) / kill

---

## 线程 & 轻进程

* 进程切换开销较大
* 执行流之间具有内在的逻辑关系

### 线程 / 轻进程LWP 是进程内的一个相对独立的执行流

* 执行同一程序中的相同 / 不同代码
  * 合作的 / 同构的
* 共享数据区 & 堆
* 进程：资源的分配单位；线程：CPU调度单位
* 上下文切换速度快 / 系统开销小 / 通信容易

### 线程 结构

* 用户级别线程ULT User level Thread
  * 库函数控制
  * OS 不可见
* 核心级别线程KLT Kernel level Thread
  * 线程是调度的基本单位
  * 并发性好
  * 开销大
* 混合进程 hybird thread
  * Solaris 中进程称为task
  * 用户级别线程 --轻进程-- 系统级别线程

#### 线程控制块TCB Thread Control Block

* 可位于系统空间 / 用户空间

---

## 作业

> 用户要求计算机系统为其完成的计算任务
* 批处理作业
  * 作业控制块JCB
  * 假脱机输入程序SPOOLing
* 交互式作业
  * 分时用户的一次登录成为作业

---

### Java线程

* Runnable = run + ready
* Java不是操作系统不能直接分派处理器

### Linux

* fork 创建全新上下文的独立地址空间
* clone (function, stack_ptr, sharing_flag, arg) // ；新栈顶；共享标记；；
  * 不产生新的地址空间
  * 细粒度的共享成分控制

### Windows

* OM 创建进程对象
* 线程是核心调度的基本单位
  * +用户栈 & 系统栈
  * 过度态transition 类似就绪态，核心堆栈位于外部存储器
* 纤程fiber --用户级别线程或轻进程