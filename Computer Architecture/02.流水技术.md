# 流水技术

* 一条指令简单3阶段
  * 取指
  * 分析
  * 执行
* 解决内存冲突问题：实现流水线，二次重叠执行方式
  * 设置两个独立编址的存储器：指令和数据存储器
  * 设置两个cache：指令和数据cache
  * 主存采用多体交叉结构
    * 单个存储器并行取数
  * 增设缓冲站，在主存和分析部件之间
> 在使用缓冲站解决问题时，设置两个程序计数器。
> * 先行程序计数器PCI，用于从主存预取指令；
> * 现行程序计数器，用来记录指令分析部件当前正在分析的指令地址。

## 流水线技术 pipelining

* 把一个重读的过程分解为若干子过程,每个子过程由专门的功能部件实现.将多个处理过程在时间上错开,依次通过各种功能段,这样每个子过程就可以与其他子过程并行进行.
* 流水线的级 / 段
  * 流水线中的每个子过程及其功能部件
  * 相互连接形成流水线
  * 流水线深度:段数
* 特点
  * 把一个处理过程分解为若干个子过程,每个子过程由一个专门的功能部件实现
  * 流水线中各段的时间应尽可能相等,否则将引起流水线阻塞/断流,因为时间长的段建成为流水线的瓶颈 bottleneck
  * 流水新每一个功能部件的后面都有一个缓冲寄存器(锁存器),称为流水寄存器,在相邻的两段之间传递数据

### 划分

* 单功能流水线 unifunction pipelines
  * 只能完成一种固定功能的流水线
* 多功能流水线 multifuncion pipelines
  * 各段可以进行不同的链接,以实现不同的功能
* 静态流水线
  * 在同一时间内,多功能能流水线各段只能按同一种功能的连接方式工作.
  * 当要按照另一种连接实现其他功能时,必须等原来所有任务都流出流水线,才能改变连接
* 动态流水线
  * 在同一时间内,多功能流水线中的各段可以按照不同的方式连接,同时执行多种功能.
  * 过于复杂
* 部件级 流水线
  * / 运算操作流水线 arithmetic pipeline
  * 将处理机的算术逻辑运算部件分段,使得各种类型的运算操作能够按流水方式进行
* 处理机级 流水线
  * / 指令流水线 instruction pipeline
  * 把指令的解释执行过程按照流水方式处理,把一条指令的执行过程分解为若干个子过程,每个子过程在独立的功能部件中执行
* 处理机间 流水线
  * / 宏流水线 macro pipeline
  * 由两个或两个以上的处理机串行,对同一数据流进行处理,每个处理机完成整个任务的一部分
  * 前一个处理机的输出结果存入存储器.作为后一个处理机的输入
* 线性流水线
  * 流水线的各段串行连接,没有反馈回路
  * 数据通过流水线中的各段时,每一段最多一次
* 非线性流水线
  * 流水线中除了有串行的连接外,还有反馈回路
* 顺序流水线 in-order pipeliine
  * 流水线输出端任务流出的顺序与输入端任务流入顺序完全相同.任务的流动依次进行.
* 乱序流水线 out-of-order pipeline
  * 可以不同
  * / 异步流水线

### 吞吐率 TP

* Through Put
* 单位时间内流水线所完成的任务数量或输出结果的数量
* TP = n/TK
* 时间均等的流水线
  * Tk = (k+n-1)Δt
  * TP = n/(k+n-1) \* 1/Δt = n/(k+n-1) \* TP max
* 时间不完全相等的流水线
  * TP = n/ ∑Δti + (n-i)max(Δt1,Δt2, ... ,Δtk)
  * TP max = 1/ max(Δt1,Δt2, ... ,Δtk)
  * TP由时间最长的那个段决定，该段成为整个流水线的瓶颈

### 解决流水线瓶颈问题的常用方法

* 细分瓶颈段
  * 增加流水线段数
* 重复设置瓶颈段
  * 重复设置瓶颈段的执行部件

* 加速比 speedup
  * 完成同一批任务,不使用流水线所有的时间 / 使用后所用的时间
  * S = nk / (k+n-1)
  * 当n>>k时，流水线的加速比等于流水线的段数
* 效率 efficiency
  * 流水线中的设备实际使用时间 / 整个运行时间
  * 各段时间相同
    * E = n / (k+n-1)
  * 时间不同
    * 总运行时间等于最长时间段\*n
* 设计中的若干个问题
  * 瓶颈问题
  * 流水线的额外开销
    * 流水线寄存器延迟和时钟偏移开销（约束了流水线深度）
    * 冲突问题（指令间存在关联）
* 流水线冲突 pipeline hazards
  > 对于具体流水线来说，由于相关的存在，使得指令流中的下一条指令无法在指定的时钟周期执行
  * 结构冲突 structural hazards
    * 因硬件资源满足不了指令重叠执行的要求
  * 数据冲突 data hazards
    * 指令在流水线中重叠执行时，因需要用到前面指令的执行结果
  * 控制冲突 control hazards
    * 流水线遇到分支指令和其他会改变PC的指令

---

## 向量处理机

### 向量运算的处理方式

* 横向（水平）处理方式
* 纵向（垂直）处理方式
* break point